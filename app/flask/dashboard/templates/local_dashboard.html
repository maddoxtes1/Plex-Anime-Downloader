<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Dashboard Plex-Anime-Downloader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">
    <style>
        {{ theme_css|safe }}
        
        /* Modifier le wrapper pour prendre toute la largeur */
        .wrapper {
            max-width: 95% !important;
            margin: 24px auto !important;
            padding: 0 24px 32px !important;
        }
        
        /* Supprimer l'espace en haut de l'onglet news */
        #tab-news {
            margin-top: 0 !important;
        }
        
        /* Supprimer les espaces en d√©but de contenu des news */
        .news-list .card > div:last-child {
            text-indent: 0 !important;
            padding-left: 0 !important;
        }
        
        /* Styles pour le rendu Markdown dans les news */
        .news-content h1, .news-content h2, .news-content h3, .news-content h4, .news-content h5, .news-content h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
        }
        .news-content h1 { font-size: 1.5em; }
        .news-content h2 { font-size: 1.3em; }
        .news-content h3 { font-size: 1.1em; }
        .news-content h4 { font-size: 1em; }
        .news-content h5 { font-size: 0.9em; }
        .news-content h6 { font-size: 0.85em; }
        .news-content p {
            margin: 0.5em 0;
        }
        .news-content ul, .news-content ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }
        .news-content li {
            margin: 0.25em 0;
        }
        .news-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }
        .news-content pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin: 1em 0;
        }
        .news-content pre code {
            background: none;
            padding: 0;
        }
        .news-content blockquote {
            border-left: 4px solid #ccc;
            padding-left: 1em;
            margin: 1em 0;
            color: #666;
        }
        .news-content a {
            color: #667eea;
            text-decoration: underline;
        }
        .news-content a:hover {
            color: #5568d3;
        }
        .news-content strong {
            font-weight: 600;
        }
        .news-content em {
            font-style: italic;
        }
        .news-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 1.5em 0;
        }
        .news-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        .news-content table th,
        .news-content table td {
            border: 1px solid #ddd;
            padding: 0.5em;
            text-align: left;
        }
        .news-content table th {
            background: rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }
        
        /* Ajuster les boutons d'onglets pour qu'ils s'adaptent √† leur texte */
        .tab-button-header {
            flex: 0 0 auto !important;
            width: auto !important;
            min-width: auto !important;
        }
        
        /* Ajuster la taille des boutons pour correspondre au texte */
        button.btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            line-height: 1.5;
            height: auto;
        }
        
        /* Aligner les boutons dans les formulaires */
        form.inline {
            display: inline-block;
            margin: 0;
        }
        
        /* S'assurer que les boutons dans les tableaux sont align√©s */
        table td form {
            margin: 0;
        }
        
        /* Syst√®me de popup/toast */
        .popup-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .popup {
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInLeft 0.3s ease-out, fadeOut 0.3s ease-in 4.7s forwards;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }
        
        .popup.success {
            background-color: #48bb78;
            color: white;
        }
        
        .popup.error {
            background-color: #f56565;
            color: white;
        }
        
        .popup.warning {
            background-color: #ed8936;
            color: white;
        }
        
        .popup.info {
            background-color: #4299e1;
            color: white;
        }
        
        .popup-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .popup-message {
            flex: 1;
        }
        
        .popup-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .popup-close:hover {
            opacity: 1;
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* Modale de confirmation */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: {{ theme_colors.bg_card }};
            border: 1px solid {{ theme_colors.border }};
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .modal-icon {
            font-size: 2rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: {{ theme_colors.text_primary }};
        }
        
        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
            color: {{ theme_colors.text_secondary }};
        }
        
        .modal-body strong {
            color: {{ theme_colors.text_primary }};
        }
        
        .modal-warning {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            color: {{ theme_colors.text_primary }};
        }
        
        .modal-warning strong {
            color: {{ theme_colors.accent_tertiary if theme_colors.accent_tertiary else '#ffbe0b' }};
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .modal-btn-cancel {
            background: {{ theme_colors.bg_secondary }};
            color: {{ theme_colors.text_primary }};
            border: 1px solid {{ theme_colors.border }};
        }
        
        .modal-btn-cancel:hover {
            background: {{ theme_colors.border }};
        }
        
        .modal-btn-confirm {
            background: {{ theme_colors.error }};
            color: white;
            border: 1px solid {{ theme_colors.error }};
        }
        
        .modal-btn-confirm:hover {
            filter: brightness(1.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="{{ url_for('static', filename='icon.png') }}" alt="Icon" style="width: 32px; height: 32px;">
            <h1>Dashboard Plex-Anime-Downloader</h1>
        </div>
        <div class="right">
            <!-- Barre d'onglets -->
            <div class="tabs-container-header">
                <button class="tab-button-header" onclick="switchTab('news')" id="btn-tab-news">üì∞ Actualit√©s</button>
                <button class="tab-button-header" onclick="switchTab('logs')" id="btn-tab-logs">üìã Logs</button>
                <button class="tab-button-header" onclick="switchTab('settings')" id="btn-tab-settings">‚öôÔ∏è Param√®tres</button>
            </div>
            <a href="{{ url_for('local.local_logout') }}">D√©connexion</a>
        </div>
    </header>

    <!-- Container pour les popups -->
    <div class="popup-container" id="popup-container"></div>
    
    <!-- Modale de confirmation pour suppression -->
    <div class="modal-overlay" id="delete-confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <h3 class="modal-title">Confirmer la suppression</h3>
            </div>
            <div class="modal-body">
                <p>Voulez-vous vraiment supprimer le dossier <strong id="delete-path-name"></strong> ?</p>
                <div class="modal-warning">
                    <strong>‚ö†Ô∏è Attention :</strong> Si vous cliquez sur "Continuer", tous les fichiers pr√©sents dans ce dossier seront d√©finitivement supprim√©s. Cette action est irr√©versible.
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Annuler</button>
                <button class="modal-btn modal-btn-confirm" id="confirm-delete-btn">Continuer</button>
            </div>
        </div>
    </div>

    <div class="wrapper">
        <div class="card" style="padding: 0;">

            <!-- Onglet Actualit√©s -->
            <div id="tab-news" class="tab-content card">
                <h2 class="section-title">Actualit√©s</h2>
                <p class="sub">
                    Restez inform√© des derni√®res mises √† jour et nouveaut√©s de Plex Anime Downloader.
                </p>


                {% if news_disabled %}
                    <div class="empty" style="padding: 24px; text-align: center; background: rgba(245, 101, 101, 0.1); border: 1px solid rgba(245, 101, 101, 0.3); border-radius: 8px;">
                        <p style="font-size: 1rem; margin-bottom: 12px; color: #f56565;">
                            <strong>‚ö†Ô∏è Les actualit√©s sont d√©sactiv√©es</strong>
                        </p>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 16px;">
                            Pour recevoir les actualit√©s et mises √† jour, veuillez r√©activer l'option "Activer les actualit√©s" dans l'onglet <strong>Param√®tres</strong>.
                        </p>
                        <a href="#settings" onclick="switchTab('settings')" style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            Aller aux Param√®tres
                        </a>
                    </div>
                {% elif news_list %}
                    <div class="news-list" style="display: flex; flex-direction: column; gap: 16px;">
                        {% for news_item in news_list %}
                            <div class="card" style="margin-bottom: 0; padding: 16px; border-left: 4px solid {% if news_item.type == 'update' %}#667eea{% elif news_item.type == 'warning' %}#f56565{% elif news_item.type == 'info' %}#48bb78{% elif news_item.type == 'announcement' %}#ed8936{% else %}#95a5a6{% endif %};">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 1.2rem;">
                                        {% if news_item.type == 'update' %}üîÑ
                                        {% elif news_item.type == 'warning' %}‚ö†Ô∏è
                                        {% elif news_item.type == 'info' %}‚ÑπÔ∏è
                                        {% elif news_item.type == 'announcement' %}üì¢
                                        {% else %}üí¨{% endif %}
                                    </span>
                                    <h3 style="margin: 0; flex: 1; font-size: 1.1rem; color: inherit;">
                                        {{ news_item.title }}
                                    </h3>
                                    <span style="background: {% if news_item.type == 'update' %}#667eea{% elif news_item.type == 'warning' %}#f56565{% elif news_item.type == 'info' %}#48bb78{% elif news_item.type == 'announcement' %}#ed8936{% else %}#95a5a6{% endif %}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase;">
                                        {{ news_item.type or 'message' }}
                                    </span>
                                </div>
                                {% if news_item.version %}
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 8px;">
                                        <strong>Version:</strong> {{ news_item.version }}
                                    </div>
                                {% endif %}
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 12px;">
                                    <strong>Publi√©:</strong> {{ news_item.created_at[:19] }}
                                </div>
                                <div class="news-content" style="font-size: 0.9rem; color: #555; line-height: 1.6; text-align: left; text-indent: 0;">
                                    {% if news_item.get('content_is_html', False) %}
                                        {{ news_item.content|safe }}
                                    {% else %}
                                        <div style="white-space: pre-wrap;">{{ news_item.content }}</div>
                                    {% endif %}
                                </div>
                            </div>
                    {% endfor %}
                    </div>
                {% elif not news_error %}
                    <div class="empty">
                        <p>Aucune actualit√© pour le moment.</p>
                        <p>Les actualit√©s seront affich√©es ici prochainement.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Onglet Param√®tres -->
            <div id="tab-settings" class="tab-content">
                <div class="card mt-4">
                    <h2 class="section-title">Utilisateurs enregistr√©s</h2>
                    <p class="sub">
                        Comptes utilis√©s par l'extension (base SQLite locale).
                    </p>

                    {% if users %}
                        <table class="mb-3">
                            <thead>
                                <tr>
                                    <th>Nom d'utilisateur</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in users %}
                                    <tr>
                                        <td>{{ u["username"] }}</td>
                                        <td>
                                            <form class="inline" method="post" action="{{ url_for('local.local_delete_user') }}">
                                                <input type="hidden" name="username" value="{{ u['username'] }}">
                                                <button class="btn danger" type="submit">Supprimer</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty mb-3">
                            Aucun utilisateur pour le moment. Cr√©e des comptes via l'extension
                            ou ici depuis l'interface admin.
                        </div>
                    {% endif %}

                    <form method="post" action="{{ url_for('local.local_create_user') }}" class="mt-2">
                        <label class="small">Ajouter un utilisateur :</label><br>
                        <input class="medium" type="text" name="username" placeholder="username" required>
                        <input class="medium" type="password" name="password" placeholder="mot de passe" required>
                        <button class="btn primary" type="submit">Cr√©er</button>
                    </form>
                </div>

                <div class="card mt-4">
                    <h2 class="section-title">Th√®me de l'interface</h2>
                    <p class="sub">
                        Choisissez le th√®me visuel pour le dashboard et l'extension.
                    </p>
                    <form method="post" action="{{ url_for('local.local_update_theme') }}">
                        <div class="mb-2">
                            <label class="small" for="theme">Th√®me actuel :</label>
                            <select name="theme" id="theme" style="width: 200px;">
                                {% for theme_key, theme_name in available_themes.items() %}
                                    <option value="{{ theme_key }}" {% if theme_key == current_theme %}selected{% endif %}>
                                        {{ theme_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button class="btn primary" type="submit">Changer le th√®me</button>
                    </form>
                </div>

                <div class="card mt-4">
                    <h2 class="section-title">Configuration Docker (config.conf)</h2>
                    <p class="sub">
                        Fichier : <code>{{ CONFIG_PATH if CONFIG_PATH is defined else 'config.conf' }}</code>.
                        Contr√¥le des threads, timer et options de scan.
                    </p>

                    <form method="post" action="{{ url_for('local.local_update_config') }}">
                        <!-- Section principale -->
                        <div class="mb-2">
                            <label class="small" for="threads">Threads</label>
                            <input class="short" type="number" id="threads" name="threads" min="1" value="{{ config.threads }}">
                        </div>
                        <div class="mb-2">
                            <label class="small" for="timer">Timer (secondes)</label>
                            <input class="short" type="number" id="timer" name="timer" min="1" value="{{ config.timer }}">
                        </div>
                        <div class="mb-2">
                            <label class="small">
                                <input type="checkbox" name="news" {% if config.get('news', True) %}checked{% endif %}>
                                Activer les actualit√©s (ping automatique vers le serveur)
                            </label>
                        </div>
                        <div class="mb-3">
                            <label class="small" for="log_level">Niveau de log</label>
                            <select id="log_level" name="log_level" class="medium">
                                <option value="DEBUG" {% if config.get('log_level', 'INFO') == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="INFO" {% if config.get('log_level', 'INFO') == 'INFO' %}selected{% endif %}>INFO</option>
                                <option value="WARNING" {% if config.get('log_level', 'INFO') == 'WARNING' %}selected{% endif %}>WARNING</option>
                                <option value="ERROR" {% if config.get('log_level', 'INFO') == 'ERROR' %}selected{% endif %}>ERROR</option>
                                <option value="CRITICAL" {% if config.get('log_level', 'INFO') == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                            </select>
                        </div>
                        
                        <!-- S√©paration visuelle -->
                        <hr style="margin: 1.5em 0; border: none; border-top: 1px solid #ddd; opacity: 0.5;">
                        
                        <!-- Section scan -->
                        <div class="mb-2">
                            <label class="small">
                                <input type="checkbox" name="anime_sama" {% if config.anime_sama %}checked{% endif %}>
                                Activer scan anime-sama
                            </label>
                        </div>
                        <div class="mb-3">
                            <label class="small">
                                <input type="checkbox" name="franime" {% if config.franime %}checked{% endif %}>
                                Activer scan franime (est dev mais ne marche pas parceque il on une protection antibot)
                            </label>
                        </div>
                        
                        <button class="btn primary" type="submit">Sauvegarder config.conf</button>
                    </form>
                </div>

                <div class="card mt-4">
                    <h2 class="section-title">Extension Chrome</h2>
                    <p class="sub">
                        T√©l√©chargez l'extension Chrome pour ajouter des animes √† la liste de t√©l√©chargement depuis anime-sama.eu.
                    </p>
                    <div class="mt-2">
                        <a href="{{ url_for('local.local_download_extension') }}" class="btn primary" style="text-decoration: none; display: inline-block;">
                            T√©l√©charger l'extension (.zip)
                        </a>
                    </div>
                    <p class="sub mt-2" style="font-size: 0.75rem; color: #6b7280;">
                        Instructions : D√©compressez le fichier ZIP, allez dans Chrome ‚Üí Extensions ‚Üí Mode d√©veloppeur ‚Üí Charger l'extension non empaquet√©e, puis s√©lectionnez le dossier d√©compress√©.
                    </p>
                </div>

                <div class="card mt-4">
                    <h2 class="section-title">Chemins Plex (plex_path.json)</h2>
                    <p class="sub">
                        Racine Plex : <code>{{ plex_root }}</code><br>
                        Chaque entr√©e correspond √† un dossier (path) dans Plex, avec une ou plusieurs langues.<br>
                        Vous pouvez modifier le langage des dossiers, mais un langage ne peut exister que dans un seul dossier.
                        voici les langues disponible: vostfr, va, vf, vkr, vcn, vqc, vf1, vf2, vj.
                    </p>

                    {% if plex_entries %}
                        <table class="mb-3">
                            <thead>
                                <tr>
                                    <th>Path</th>
                                    <th>Langues</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for e in plex_entries %}
                                    <tr>
                                        <td>
                                            <form class="inline" method="post" action="{{ url_for('local.local_plex_update') }}">
                                                <input type="hidden" name="old_path" value="{{ e.path }}">
                                                <input class="medium" type="text" name="path" value="{{ e.path }}">
                                        </td>
                                        <td>
                                                <input class="medium" type="text" name="languages" value="{{ e.language|join(', ') }}">
                                        </td>
                                        <td>
                                                <button class="btn" type="submit">Mettre √† jour</button>
                                            </form>
                                            <form class="inline plex-delete-form" method="post" action="{{ url_for('local.local_plex_delete') }}" onsubmit="return confirmDeletePlexPath(event, '{{ e.path }}')">
                                                <input type="hidden" name="path" value="{{ e.path }}">
                                                <button class="btn danger" type="submit">Supprimer</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty mb-3">
                            Aucun chemin configur√© pour l'instant.
                        </div>
                    {% endif %}

                    <form method="post" action="{{ url_for('local.local_plex_add') }}" class="mt-2">
                        <label class="small">Ajouter / mettre √† jour un chemin :</label><br>
                        <input class="medium" type="text" name="path" placeholder="ex: anime_vf" required>
                        <input class="medium" type="text" name="languages" placeholder="ex: vf, vj">
                        <button class="btn primary" type="submit">Enregistrer</button>
                    </form>
                </div>
            </div>

            <!-- Onglet Logs -->
            <div id="tab-logs" class="tab-content">
                <div class="card mt-4">
                    <h2 class="section-title">Fichiers de logs</h2>
                    <p class="sub">
                        Consultez les logs de l'application et du conteneur Docker en temps r√©el.
                    </p>

                    <div class="log-selector">
                        <label class="small" for="log-file-select">S√©lectionner un fichier de log :</label>
                        <select id="log-file-select" class="medium" style="width: 100%; max-width: 300px;" onchange="onLogFileChange()">
                            <option value="">-- Choisir un fichier --</option>
                            <option value="__docker__">üê≥ Docker logs (temps r√©el)</option>
                            {% if log_files %}
                                {% for log_file in log_files %}
                                    <option value="{{ log_file.name }}" data-size="{{ log_file.size_mb }}">
                                        {{ log_file.name }} ({{ log_file.size_mb }} MB)
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    <div class="log-controls">
                        <button class="btn primary" onclick="loadLogFile()" id="btn-load-log">Charger le fichier</button>
                        <button class="btn primary" onclick="startDockerLogs()" id="btn-start-stream" style="display: none;">D√©marrer le streaming</button>
                        <button class="btn danger" onclick="stopDockerLogs()" id="btn-stop-stream" style="display: none;">Arr√™ter le streaming</button>
                        <button class="btn" onclick="clearLogViewer()">Effacer</button>
                        <div class="log-auto-scroll">
                            <input type="checkbox" id="auto-scroll" checked>
                            <label class="small" for="auto-scroll">D√©filement automatique</label>
                        </div>
                    </div>

                    <div id="log-viewer" class="log-viewer" style="display: none;">
                        <pre id="log-content" class="log-content-pre"></pre>
                    </div>

                    <div id="log-stream-viewer" class="log-viewer" style="display: none; margin-top: 12px;">
                        <pre id="log-stream-content" class="log-content-pre"></pre>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Syst√®me de popup/toast
        function showPopup(message, category = 'info') {
            const container = document.getElementById('popup-container');
            const popup = document.createElement('div');
            popup.className = `popup ${category}`;
            
            const icons = {
                'success': '‚úÖ',
                'error': '‚ö†Ô∏è',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            popup.innerHTML = `
                <span class="popup-icon">${icons[category] || icons.info}</span>
                <span class="popup-message">${message}</span>
                <button class="popup-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(popup);
            
            // Supprimer automatiquement apr√®s 5 secondes
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.style.animation = 'fadeOut 0.3s ease-in forwards';
                    setTimeout(() => popup.remove(), 300);
                }
            }, 5000);
        }
        
        // Afficher les messages flash de Flask au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        showPopup('{{ message|replace("'", "\\'")|safe }}', '{{ category }}');
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            // Afficher les erreurs de news
            {% if news_error %}
                showPopup('{{ news_error|replace("'", "\\'")|safe }}', 'error');
            {% endif %}
            
            // Nettoyer les espaces en d√©but de contenu des news (seulement pour le texte brut, pas le HTML)
            document.querySelectorAll('.news-content').forEach(function(div) {
                // V√©rifier si c'est du HTML ou du texte brut
                if (div.children.length === 0 && div.textContent) {
                    // C'est du texte brut, nettoyer les espaces
                    let text = div.textContent;
                    text = text.replace(/^[\s\n\r]+/, '');
                    if (text !== div.textContent) {
                        div.textContent = text;
                    }
                }
            });
        });
        
        function switchTab(tabName, updateHash = true) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons
            document.querySelectorAll('.tab-button-header').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher l'onglet s√©lectionn√©
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Activer le bouton correspondant
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Si appel√© programmatiquement, utiliser l'ID du bouton
                const btnId = 'btn-tab-' + tabName;
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.add('active');
                }
            }
            
            // Mettre √† jour l'URL avec le fragment seulement si demand√©
            // (pour √©viter les boucles infinies avec hashchange)
            if (updateHash && window.location.hash.substring(1) !== tabName) {
                window.location.hash = tabName;
            }
        }
        
        // D√©tecter le fragment dans l'URL au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.substring(1); // Enlever le #
            if (hash && ['news', 'logs', 'settings'].includes(hash)) {
                // Ne pas mettre √† jour le hash car il est d√©j√† dans l'URL
                switchTab(hash, false);
            } else {
                // Par d√©faut, activer l'onglet news seulement si pas de hash
                if (!window.location.hash) {
                    switchTab('news', false);
                }
            }
        });
        
        // √âcouter les changements de hash dans l'URL (pour les redirections)
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.substring(1);
            if (hash && ['news', 'logs', 'settings'].includes(hash)) {
                // Ne pas mettre √† jour le hash car il vient d'√™tre chang√©
                switchTab(hash, false);
            }
        });

        let logEventSource = null;

        function onLogFileChange() {
            const select = document.getElementById('log-file-select');
            const value = select.value;
            const btnLoad = document.getElementById('btn-load-log');
            const btnStart = document.getElementById('btn-start-stream');
            const btnStop = document.getElementById('btn-stop-stream');
            
            if (value === '__docker__') {
                btnLoad.style.display = 'none';
                btnStart.style.display = 'inline-block';
                btnStop.style.display = 'none';
            } else if (value) {
                btnLoad.style.display = 'inline-block';
                btnStart.style.display = 'none';
                btnStop.style.display = 'none';
            } else {
                btnLoad.style.display = 'inline-block';
                btnStart.style.display = 'none';
                btnStop.style.display = 'none';
            }
        }

        function loadLogFile() {
            const select = document.getElementById('log-file-select');
            const filename = select.value;
            
            if (!filename || filename === '__docker__') {
                alert('Veuillez s√©lectionner un fichier de log');
                return;
            }
            
            // Arr√™ter le streaming si actif
            if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
            }
            document.getElementById('log-stream-viewer').style.display = 'none';
            
            const viewer = document.getElementById('log-viewer');
            const content = document.getElementById('log-content');
            
            viewer.style.display = 'block';
            content.textContent = 'Chargement...';
            
            fetch(`/local/logs/view/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        // Formater le contenu pour pr√©server les sauts de ligne
                        const lines = data.content.split('\n');
                        content.textContent = lines.join('\n');
                        if (document.getElementById('auto-scroll').checked) {
                            setTimeout(() => {
                                viewer.scrollTop = viewer.scrollHeight;
                            }, 100);
                        }
                    } else {
                        content.textContent = 'Erreur: ' + data.error;
                    }
                })
                .catch(error => {
                    content.textContent = 'Erreur lors du chargement: ' + error;
                });
        }

        function clearLogViewer() {
            document.getElementById('log-content').textContent = '';
            document.getElementById('log-viewer').style.display = 'none';
            document.getElementById('log-stream-content').textContent = '';
            document.getElementById('log-stream-viewer').style.display = 'none';
            if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
            }
            document.getElementById('btn-stop-stream').style.display = 'none';
            document.getElementById('btn-start-stream').style.display = 'none';
        }

        function startDockerLogs() {
            const select = document.getElementById('log-file-select');
            const value = select.value;
            
            if (!value) {
                alert('Veuillez s√©lectionner une source de logs');
                return;
            }
            
            // Masquer le viewer statique
            document.getElementById('log-viewer').style.display = 'none';
            
            // Arr√™ter le streaming pr√©c√©dent si actif
            if (logEventSource) {
                logEventSource.close();
            }
            
            const streamViewer = document.getElementById('log-stream-viewer');
            const streamContent = document.getElementById('log-stream-content');
            const btnStart = document.getElementById('btn-start-stream');
            const btnStop = document.getElementById('btn-stop-stream');
            
            streamViewer.style.display = 'block';
            streamContent.textContent = '';
            btnStart.style.display = 'none';
            btnStop.style.display = 'inline-block';
            
            // D√©terminer l'URL du streaming
            let streamUrl;
            if (value === '__docker__') {
                streamUrl = '/local/logs/stream/docker';
            } else {
                streamUrl = `/local/logs/stream/${encodeURIComponent(value)}`;
            }
            
            logEventSource = new EventSource(streamUrl);
            
            logEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.content) {
                        streamContent.textContent += data.content;
                        if (document.getElementById('auto-scroll').checked) {
                            setTimeout(() => {
                                streamViewer.scrollTop = streamViewer.scrollHeight;
                            }, 50);
                        }
                    } else if (data.error) {
                        streamContent.textContent += '\n[Erreur] ' + data.error;
                    }
                } catch (e) {
                    console.error('Erreur parsing SSE:', e);
                }
            };
            
            logEventSource.onerror = function(error) {
                console.error('Erreur SSE:', error);
                if (logEventSource.readyState === EventSource.CLOSED) {
                    streamContent.textContent += '\n[Connexion ferm√©e]';
                    btnStart.style.display = 'inline-block';
                    btnStop.style.display = 'none';
                }
            };
        }

        function stopDockerLogs() {
            if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
            }
            document.getElementById('log-stream-viewer').style.display = 'none';
            document.getElementById('btn-start-stream').style.display = 'inline-block';
            document.getElementById('btn-stop-stream').style.display = 'none';
        }

        // Auto-scroll pour le viewer de logs
        document.getElementById('log-viewer').addEventListener('scroll', function() {
            const autoScroll = document.getElementById('auto-scroll');
            if (this.scrollTop + this.clientHeight < this.scrollHeight - 10) {
                autoScroll.checked = false;
            }
        });
        
        // Gestion de la modale de confirmation pour suppression de chemin Plex
        let pendingDeleteForm = null;
        
        function confirmDeletePlexPath(event, pathName) {
            event.preventDefault();
            // R√©cup√©rer le formulaire parent (event.target est le bouton, event.currentTarget est le formulaire)
            pendingDeleteForm = event.currentTarget || event.target.closest('form');
            
            // Afficher le nom du dossier dans la modale
            document.getElementById('delete-path-name').textContent = pathName;
            
            // Afficher la modale
            document.getElementById('delete-confirm-modal').classList.add('show');
            
            // G√©rer le clic sur le bouton de confirmation
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = function() {
                if (pendingDeleteForm) {
                    pendingDeleteForm.submit();
                }
            };
            
            return false;
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.remove('show');
            pendingDeleteForm = null;
        }
        
        // Fermer la modale en cliquant sur l'overlay
        document.getElementById('delete-confirm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // Fermer la modale avec la touche Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>

