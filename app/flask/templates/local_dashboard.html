<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Dashboard local - Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #020617;
            color: #e5e7eb;
            margin: 0;
            min-height: 100vh;
        }
        header {
            background: #0f172a;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1e293b;
        }
        header h1 {
            font-size: 1.1rem;
            margin: 0;
        }
        header .right {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            color: #9ca3af;
        }
        header a {
            color: #e5e7eb;
            text-decoration: none;
            padding: 5px 8px;
            border-radius: 999px;
            border: 1px solid #374151;
        }
        header a:hover {
            background: #111827;
        }
        .wrapper {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 16px 32px;
        }
        .card {
            background: #020617;
            border-radius: 14px;
            border: 1px solid #1f2937;
            padding: 18px 20px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.8);
        }
        h2 {
            font-size: 1rem;
            margin: 0 0 8px;
        }
        p {
            font-size: 0.9rem;
            color: #9ca3af;
            margin: 0 0 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 8px 6px;
            text-align: left;
        }
        th {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #9ca3af;
            border-bottom: 1px solid #1f2937;
        }
        tr:nth-child(even) td {
            background: #020617;
        }
        tr:nth-child(odd) td {
            background: #030712;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(34, 197, 94, 0.12);
            color: #bbf7d0;
            border: 1px solid rgba(34, 197, 94, 0.35);
        }
        .messages {
            margin-bottom: 12px;
        }
        .msg {
            font-size: 0.8rem;
            padding: 6px 8px;
            border-radius: 8px;
            margin-bottom: 4px;
        }
        .msg.error {
            background: rgba(248, 113, 113, 0.15);
            color: #fecaca;
        }
        .msg.success {
            background: rgba(34, 197, 94, 0.12);
            color: #bbf7d0;
        }
        .empty {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 4px;
        }
        .section-title {
            margin-top: 4px;
            margin-bottom: 4px;
        }
        .sub {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 10px;
        }
        form.inline {
            display: inline;
        }
        label.small {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-right: 6px;
        }
        input[type="text"],
        input[type="number"],
        input[type="password"] {
            background: #020617;
            border-radius: 8px;
            border: 1px solid #374151;
            color: #e5e7eb;
            padding: 4px 6px;
            font-size: 0.85rem;
        }
        input.short {
            width: 70px;
        }
        input.medium {
            width: 140px;
        }
        button.btn {
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #111827;
            color: #e5e7eb;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        button.btn.primary {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #4f46e5, #22c55e);
        }
        button.btn.danger {
            border-color: #b91c1c;
            color: #fecaca;
        }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        code {
            font-size: 0.8rem;
            background: #020617;
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Dashboard local - Admin</h1>
        <div class="right">
            <span class="badge">Accès local uniquement</span>
            <a href="{{ url_for('local.local_logout') }}">Déconnexion</a>
        </div>
    </header>

    <div class="wrapper">
        <div class="card">
            <div class="messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="msg {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <h2 class="section-title">Utilisateurs enregistrés</h2>
            <p class="sub">
                Comptes utilisés par l'extension (base SQLite locale).
            </p>

            {% if users %}
                <table class="mb-3">
                    <thead>
                        <tr>
                            <th>Nom d'utilisateur</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in users %}
                            <tr>
                                <td>{{ u["username"] }}</td>
                                <td>
                                    <form class="inline" method="post" action="{{ url_for('local.local_delete_user') }}">
                                        <input type="hidden" name="username" value="{{ u['username'] }}">
                                        <button class="btn danger" type="submit">Supprimer</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty mb-3">
                    Aucun utilisateur pour le moment. Crée des comptes via l'extension
                    ou ici depuis l'interface admin.
                </div>
            {% endif %}

            <form method="post" action="{{ url_for('local.local_create_user') }}" class="mt-2">
                <label class="small">Ajouter un utilisateur :</label><br>
                <input class="medium" type="text" name="username" placeholder="username" required>
                <input class="medium" type="password" name="password" placeholder="mot de passe" required>
                <button class="btn primary" type="submit">Créer</button>
            </form>

        </div>

        <div class="card mt-4">
            <h2 class="section-title">Configuration Docker (config.conf)</h2>
            <p class="sub">
                Fichier : <code>{{ CONFIG_PATH if CONFIG_PATH is defined else 'config.conf' }}</code>.
                Contrôle des threads, timer et options de scan.
            </p>

            <form method="post" action="{{ url_for('local.local_update_config') }}">
                <div class="mb-2">
                    <label class="small" for="threads">Threads</label>
                    <input class="short" type="number" id="threads" name="threads" min="1" value="{{ config.threads }}">
                </div>
                <div class="mb-2">
                    <label class="small" for="timer">Timer (secondes)</label>
                    <input class="short" type="number" id="timer" name="timer" min="1" value="{{ config.timer }}">
                </div>
                <div class="mb-2">
                    <label class="small">
                        <input type="checkbox" name="anime_sama" {% if config.anime_sama %}checked{% endif %}>
                        Activer scan anime-sama
                    </label>
                </div>
                <div class="mb-3">
                    <label class="small">
                        <input type="checkbox" name="franime" {% if config.franime %}checked{% endif %}>
                        Activer scan franime (est dev mais ne marche pas parceque il on une protection antibot)
                    </label>
                </div>
                <button class="btn primary" type="submit">Sauvegarder config.conf</button>
            </form>
        </div>

        <div class="card mt-4">
            <h2 class="section-title">Extension Chrome</h2>
            <p class="sub">
                Téléchargez l'extension Chrome pour ajouter des animes à la liste de téléchargement depuis anime-sama.org.
            </p>
            <div class="mt-2">
                <a href="{{ url_for('local.local_download_extension') }}" class="btn primary" style="text-decoration: none; display: inline-block;">
                    Télécharger l'extension (.zip)
                </a>
            </div>
            <p class="sub mt-2" style="font-size: 0.75rem; color: #6b7280;">
                Instructions : Décompressez le fichier ZIP, allez dans Chrome → Extensions → Mode développeur → Charger l'extension non empaquetée, puis sélectionnez le dossier décompressé.
            </p>
        </div>

        <div class="card mt-4">
            <h2 class="section-title">Chemins Plex (plex_path.json)</h2>
            <p class="sub">
                Racine Plex : <code>{{ plex_root }}</code><br>
                Chaque entrée correspond à un dossier (path) dans Plex, avec une ou plusieurs langues.<br>
                Vous pouvez modifier le langage des dossiers, mais un langage ne peut exister que dans un seul dossier.
                voici les langues disponible: vostfr, va, vf, vkr, vcn, vqc, vf1, vf2, vj.
            </p>

            {% if plex_entries %}
                <table class="mb-3">
                    <thead>
                        <tr>
                            <th>Path</th>
                            <th>Langues</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in plex_entries %}
                            <tr>
                                <td>
                                    <form class="inline" method="post" action="{{ url_for('local.local_plex_update') }}">
                                        <input type="hidden" name="old_path" value="{{ e.path }}">
                                        <input class="medium" type="text" name="path" value="{{ e.path }}">
                                </td>
                                <td>
                                        <input class="medium" type="text" name="languages" value="{{ e.language|join(', ') }}">
                                </td>
                                <td>
                                        <button class="btn" type="submit">Mettre à jour</button>
                                    </form>
                                    <form class="inline" method="post" action="{{ url_for('local.local_plex_delete') }}">
                                        <input type="hidden" name="path" value="{{ e.path }}">
                                        <button class="btn danger" type="submit">Supprimer</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty mb-3">
                    Aucun chemin configuré pour l'instant.
                </div>
            {% endif %}

            <form method="post" action="{{ url_for('local.local_plex_add') }}" class="mt-2">
                <label class="small">Ajouter / mettre à jour un chemin :</label><br>
                <input class="medium" type="text" name="path" placeholder="ex: anime_vf" required>
                <input class="medium" type="text" name="languages" placeholder="ex: vf, vj">
                <button class="btn primary" type="submit">Enregistrer</button>
            </form>
        </div>
    </div>
</body>
</html>


